<!DOCTYPE html>

<notebook theme="glacier">
  <title>Dead and Missing Migrants</title>
  BUILD SCRIPT IN R

  <script type="text/x-r" hidden>
    source("../data/build.R")
  </script>

  CSS

  <script type="text/markdown">
    <link rel="stylesheet" href="./style.css" />
  </script>

  LIBRARIES & HELPERS

  <script id="imports" type="module" hidden>
    import { formatDateFR } from "./helpers/formatDateFR.js";
    import { toGeoJSON } from "./helpers/toGeoJSON.js";
    import { clustering } from "./helpers/clustering.js";
    import { clustersDbscan } from "@turf/clusters-dbscan";
    const viz = import("geoviz");
  </script>

  PARAMS

  <script id="imports" type="module" hidden>
    const yearmin = 1993;
    const yearmax = new Date().getFullYear();
    const lang = "fr"; // "en" or "fr"
  </script>

  DATA LOADING

  <script type="module" hidden>
    let all = await FileAttachment("../data/data.csv").csv();
    let land = await FileAttachment("../data/land.json").json();
    let eu = await FileAttachment("../data/eu.json").json();
    let schengen = await FileAttachment("../data/schengen.json").json();
    let toponymes = await FileAttachment("../data/toponymes.json").json();
    let date = FileAttachment("../data/last_update.txt").text();
  </script>

  CATEGORIES & COLORS

  <script type="module" hidden>
    let types = [
      { type: "Noyade", color: "#58ABD3" },
      { type: "Suicide", color: "#F8E91F" },
      { type: "Asphyxie", color: "#6B2265" },
      {
        type: "Mort de faim, de soif, de froid ou d'épuisement",
        color: "#1C7532",
      },
      {
        type: "Homicide, torture, absence de soin, violences policières",
        color: "#F49919",
      },
      {
        type: "Empoisonnement, Champ de mine, accident, autre",
        color: "#637A84",
      },
    ];
  </script>

  SVG CONTAINER

  <script type="module" hidden>
    let svg = viz.create({
      projection: "AzimuthalEqualArea.rotate([-20,-52])",
      domain: [
        [-25, 19],
        [42, 55],
      ],
      margin: 20,
      background: "#bde1f0",
      responsive: true,
      zoomable: true,
    });
  </script>

  FILTER

  <script type="module" hidden>
    const check = new Map(
      viz.tool
        .project(viz.tool.featurecollection(all, { lat: "lat", lon: "lng" }), {
          projection: svg.projection,
        })
        .features.map((d) => [d.properties.id, d.geometry?.coordinates])
    );
  </script>

  <script type="module" hidden>
    let data = all.filter((d) => Array.isArray(check.get(d.id)));
  </script>

  CLUSTERING

  <script type="module" hidden>
    let categories = types.map((d) => d.type);
    let features = [];
    categories.forEach((categ) => {
      let mycateg = data.filter((d) => d.fr == categ);
      features.push(clustering(toGeoJSON(mycateg), 20, categ).features);
    });
    let clusters = { type: "FeatureCollection", features: features.flat() };
  </script>

  SOME TEXTS TO DISPLAY

  <script type="module" hidden>
    let source1 = "UNITED for Intercultural\nAction (1993-1999)";
    let source2 = `The "Migrants Files" project\n(2000 - 2013)`;
    let source3 =
      lang == "en"
        ? "International Organization\nfor Migration\n(2014 to now)"
        : "Organisation Internationale\npour les Migrations\n(2014 à aujourd'hui)";

    let source =
      lang == "en"
        ? "Map design\nNicolas Lambert, 2025"
        : "Cartographie\nNicolas Lambert, 2025\n";

    if (yearmin < 2000) {
      source += "\n" + source1;
    }
    if (yearmin <= 2013 && yearmax >= 2000) {
      source += "\n" + source2;
    }
    if (yearmax >= 2014) {
      source += "\n" + source3;
    }
  </script>

  <script type="module" hidden>
    let update = new Date(date);
    let Difference_In_Time =
      update.getTime() - new Date(`${yearmin}-01-01`).getTime();
    const days = Math.round(Difference_In_Time / (1000 * 3600 * 24));
    const weeks = days / 7;
    const nbbyweek = Math.round(d3.sum(data.map((d) => d.nb)) / weeks);
  </script>

  MAP VISUALIZATION

  <script type="module" hidden>
    svg.graticule({ type: "graticule", id: "graticule", stroke: "white" });
    svg.plot({
      data: land,
      id: "countries",
      fill: "#E6DED4",
      strokeWidth: 0.3,
    });

    svg.plot({
      datum: eu,
      fill: "#E2BD93",
      id: "eu27",
      strokeWidth: 0.5,
      filter: svg.effect.shadow({
        stdDeviation: 2,
        fill: "black",
        fillOpacity: 0.2,
        dx: 2,
        dy: 2,
      }),
    });

    svg.plot({
      type: "proptypo",
      data: clusters,
      var1: "nb",
      var2: "type",
      colors: types.map((d) => d.color),
      k: 75,
      tip: (d) =>
        `${d.properties.type}\n ${d.properties.nb} personne${
          d.properties.nb > 1 ? "s" : ""
        }`,
      stroke: "white",
      strokeWidth: 0.2,
      leg2_rect_width: 15,
      leg2_rect_height: 15,
      leg2_pos: [25, 215],
      leg2_title: "Cause de la mort",
      leg2_values_stroke: "#bde1f0",
      leg2_values_strokeWidth: 14,
      leg2_values_dx: 8,
      leg2_values_paintOrder: "stroke",
      leg2_values_strokeLinejoin: "round",
      leg1_pos: [20, 20],
      leg1_values_round: 0,
      leg1_title: "Nombre de morts",
      leg1_subtitle: `Du 1er janvier 1993 au ${formatDateFR(date)}`,
      leg1_title_dy: -5,
    });

    svg.path({
      datum: schengen,
      id: "schengen",
      stroke: "#383333",
      strokeDasharray: [5, 3],
      strokeOpacity: 0.5,
      strokeWidth: 1.4,
      filter: svg.effect.shadow({
        stdDeviation: 1,
        fill: "black",
        fillOpacity: 0.5,
        dx: 1,
        dy: 1,
      }),
    });
    svg.scalebar({
      id: "scale",
      units: "km",
      label: "Kilomètres",
    });
    svg.header({
      text: "Des morts par milliers aux portes de l'Europe",
      id: "header",
      background_fill: "#454545",
      fill: "white",
    });
    toponymes.forEach((d) => {
      svg.text({
        id: d.id,
        pointerEvents: "none",
        coords: "geo",
        pos: [d.pos[1], d.pos[0]],
        text: d.fr,
        textAnchor: d.anchor,
        fill: d.fill || "#454545",
        fillOpacity: d.fillOpacity || 1,
        fontWeight: "bold",
        strokeWidth: d.strokeWidth,
        strokeOpacity: d.strokeOpacity || 0.7,
        fontSize: d.fontSize,
        stroke: d.stroke || "white",
      });
    });
    svg.text({
      pos: [866, 15],
      textAnchor: "middle",
      fontSize: 50,
      fill: "#454545",
      fontWeight: "bold",
      text: `${d3
        .format(",.2r")(d3.sum(data.map((d) => d.nb)))
        .replace(",", " ")}`,
      id: "total",
    });

    svg.text({
      pos: [866, 65],
      textAnchor: "middle",
      fontSize: 14,
      fill: "#454545",
      stroke: "#E6DED4",
      strokeWidth: 4,
      text: `C'est le nombre de personnes\nmigrantes mortes ou portées\ndisparues en essayant de\nrejoindre l'Union européenne\nentre ${yearmin} et ${yearmax}.\n\nDit autrement, ce sont\n${nbbyweek} femmes, hommes\net enfants qui perdent\nla vie chaque semaine.`,
    });

    svg.text({
      text: source,
      pos: [svg.width - 15, 450],
      textAnchor: "end",
      fontSize: 10,
      fill: "#76858C",
      fillOpacity: 0.7,
      fontStyle: "italic",
      textDominantBaseline: "hanging",
      id: "source",
    });
    display(svg.render());
  </script>

  <script type="module">
    const button_svg = Inputs.button("Télécharger en svg");
    const button_png = Inputs.button("Télécharger en png");
    const container = document.createElement("div");
    container.className = "button-container"; // <-- ici la classe
    container.append(button_svg);
    container.append(button_png);
    display(container);
    button_svg.addEventListener("click", () => {
      viz.exportSVG(d3.select(svg.node()));
    });
    button_png.addEventListener("click", () => {
      viz.exportPNG(d3.select(svg.node()));
    });
  </script>

  TODO

  <script type="text/markdown" hidden>
    Ajouter Loes logo RIATE, CNRS ET MIGREUROP

    Ajouter le logo creative commons

    Et sous la carte, un petit texte methodo et politique.
  </script>

  SOURCES

  <script type="text/markdown">
    Nicolas Lambert<br/>CNRS, RIATE - Centre pour l'analyse spatiale et la géovisualisation<br/>
    Dernières mise à jour : ${formatDateFR(date)}
  </script>

  ROMOVE CELLS

  <script type="module">
    const cellsToRemove = [1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 17];
    for (const id of cellsToRemove) {
      document.getElementById(`cell-${id}`)?.remove();
    }
  </script>
</notebook>
