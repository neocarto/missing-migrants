function R(e){if(!e)throw new Error("geojson is required");switch(e.type){case"Feature":return B(e);case"FeatureCollection":return $(e);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return T(e);default:throw new Error("unknown GeoJSON type")}}function B(e){const t={type:"Feature"};return Object.keys(e).forEach(n=>{switch(n){case"type":case"properties":case"geometry":return;default:t[n]=e[n]}}),t.properties=F(e.properties),e.geometry==null?t.geometry=null:t.geometry=T(e.geometry),t}function F(e){const t={};return e&&Object.keys(e).forEach(n=>{const r=e[n];typeof r=="object"?r===null?t[n]=null:Array.isArray(r)?t[n]=r.map(i=>i):t[n]=F(r):t[n]=r}),t}function $(e){const t={type:"FeatureCollection"};return Object.keys(e).forEach(n=>{switch(n){case"type":case"features":return;default:t[n]=e[n]}}),t.features=e.features.map(n=>B(n)),t}function T(e){const t={type:e.type};return e.bbox&&(t.bbox=e.bbox),e.type==="GeometryCollection"?(t.geometries=e.geometries.map(n=>T(n)),t):(t.coordinates=N(e.coordinates),t)}function N(e){const t=e;return typeof t[0]!="object"?t.slice():t.map(n=>N(n))}const U=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],b=1,L=8;class D{static from(t){if(!(t instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[n,r]=new Uint8Array(t,0,2);if(n!==219)throw new Error("Data does not appear to be in a KDBush format.");const i=r>>4;if(i!==b)throw new Error(`Got v${i} data when expected v${b}.`);const o=U[r&15];if(!o)throw new Error("Unrecognized array type.");const[u]=new Uint16Array(t,2,1),[c]=new Uint32Array(t,4,1);return new D(c,u,o,t)}constructor(t,n=64,r=Float64Array,i){if(isNaN(t)||t<0)throw new Error(`Unpexpected numItems value: ${t}.`);this.numItems=+t,this.nodeSize=Math.min(Math.max(+n,2),65535),this.ArrayType=r,this.IndexArrayType=t<65536?Uint16Array:Uint32Array;const o=U.indexOf(this.ArrayType),u=t*2*this.ArrayType.BYTES_PER_ELEMENT,c=t*this.IndexArrayType.BYTES_PER_ELEMENT,s=(8-c%8)%8;if(o<0)throw new Error(`Unexpected typed array class: ${r}.`);i&&i instanceof ArrayBuffer?(this.data=i,this.ids=new this.IndexArrayType(this.data,L,t),this.coords=new this.ArrayType(this.data,L+c+s,t*2),this._pos=t*2,this._finished=!0):(this.data=new ArrayBuffer(L+u+c+s),this.ids=new this.IndexArrayType(this.data,L,t),this.coords=new this.ArrayType(this.data,L+c+s,t*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(b<<4)+o]),new Uint16Array(this.data,2,1)[0]=n,new Uint32Array(this.data,4,1)[0]=t)}add(t,n){const r=this._pos>>1;return this.ids[r]=r,this.coords[this._pos++]=t,this.coords[this._pos++]=n,r}finish(){const t=this._pos>>1;if(t!==this.numItems)throw new Error(`Added ${t} items when expected ${this.numItems}.`);return S(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(t,n,r,i){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:o,coords:u,nodeSize:c}=this,s=[0,o.length-1,0],h=[];for(;s.length;){const y=s.pop()||0,m=s.pop()||0,f=s.pop()||0;if(m-f<=c){for(let l=f;l<=m;l++){const g=u[2*l],A=u[2*l+1];g>=t&&g<=r&&A>=n&&A<=i&&h.push(o[l])}continue}const a=f+m>>1,d=u[2*a],p=u[2*a+1];d>=t&&d<=r&&p>=n&&p<=i&&h.push(o[a]),(y===0?t<=d:n<=p)&&(s.push(f),s.push(a-1),s.push(1-y)),(y===0?r>=d:i>=p)&&(s.push(a+1),s.push(m),s.push(1-y))}return h}within(t,n,r){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:i,coords:o,nodeSize:u}=this,c=[0,i.length-1,0],s=[],h=r*r;for(;c.length;){const y=c.pop()||0,m=c.pop()||0,f=c.pop()||0;if(m-f<=u){for(let l=f;l<=m;l++)I(o[2*l],o[2*l+1],t,n)<=h&&s.push(i[l]);continue}const a=f+m>>1,d=o[2*a],p=o[2*a+1];I(d,p,t,n)<=h&&s.push(i[a]),(y===0?t-r<=d:n-r<=p)&&(c.push(f),c.push(a-1),c.push(1-y)),(y===0?t+r>=d:n+r>=p)&&(c.push(a+1),c.push(m),c.push(1-y))}return s}}function S(e,t,n,r,i,o){if(i-r<=n)return;const u=r+i>>1;z(e,t,u,r,i,o),S(e,t,n,r,u-1,1-o),S(e,t,n,u+1,i,1-o)}function z(e,t,n,r,i,o){for(;i>r;){if(i-r>600){const h=i-r+1,y=n-r+1,m=Math.log(h),f=.5*Math.exp(2*m/3),a=.5*Math.sqrt(m*f*(h-f)/h)*(y-h/2<0?-1:1),d=Math.max(r,Math.floor(n-y*f/h+a)),p=Math.min(i,Math.floor(n+(h-y)*f/h+a));z(e,t,n,d,p,o)}const u=t[2*n+o];let c=r,s=i;for(E(e,t,r,n),t[2*i+o]>u&&E(e,t,r,i);c<s;){for(E(e,t,c,s),c++,s--;t[2*c+o]<u;)c++;for(;t[2*s+o]>u;)s--}t[2*r+o]===u?E(e,t,r,s):(s++,E(e,t,s,i)),s<=n&&(r=s+1),n<=s&&(i=s-1)}}function E(e,t,n,r){M(e,n,r),M(t,2*n,2*r),M(t,2*n+1,2*r+1)}function M(e,t,n){const r=e[t];e[t]=e[n],e[n]=r}function I(e,t,n,r){const i=e-n,o=t-r;return i*i+o*o}class G{constructor(t=[],n=H){if(this.data=t,this.length=this.data.length,this.compare=n,this.length>0)for(let r=(this.length>>1)-1;r>=0;r--)this._down(r)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const t=this.data[0],n=this.data.pop();return this.length--,this.length>0&&(this.data[0]=n,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:n,compare:r}=this,i=n[t];for(;t>0;){const o=t-1>>1,u=n[o];if(r(i,u)>=0)break;n[t]=u,t=o}n[t]=i}_down(t){const{data:n,compare:r}=this,i=this.length>>1,o=n[t];for(;t<i;){let u=(t<<1)+1,c=n[u];const s=u+1;if(s<this.length&&r(n[s],c)<0&&(u=s,c=n[s]),r(c,o)>=0)break;n[t]=c,t=u}n[t]=o}}function H(e,t){return e<t?-1:e>t?1:0}const Q=6371,w=Math.PI/180;function Y(e,t,n,r=1/0,i=1/0,o){let u=1;const c=[];r===void 0&&(r=1/0),i!==void 0&&(u=x(i/Q));const s=new G([],J);let h={left:0,right:e.ids.length-1,axis:0,minLng:-180,minLat:-90,maxLng:180,maxLat:90};const y=Math.cos(n*w);for(;h;){const m=h.right,f=h.left;if(m-f<=e.nodeSize)for(let a=f;a<=m;a++){const d=e.ids[a];{const p=C(t,n,e.coords[2*a],e.coords[2*a+1],y);s.push({id:d,dist:p})}}else{const a=f+m>>1,d=e.coords[2*a],p=e.coords[2*a+1],l=e.ids[a];{const O=C(t,n,d,p,y);s.push({id:l,dist:O})}const g=(h.axis+1)%2,A={left:f,right:a-1,axis:g,minLng:h.minLng,minLat:h.minLat,maxLng:h.axis===0?d:h.maxLng,maxLat:h.axis===1?p:h.maxLat,dist:0},v={left:a+1,right:m,axis:g,minLng:h.axis===0?d:h.minLng,minLat:h.axis===1?p:h.minLat,maxLng:h.maxLng,maxLat:h.maxLat,dist:0};A.dist=P(t,n,y,A),v.dist=P(t,n,y,v),s.push(A),s.push(v)}for(;s.length&&s.peek().id!=null;){const a=s.pop();if(a.dist>u||(c.push(a.id),c.length===r))return c}h=s.pop()}return c}function P(e,t,n,r){const i=r.minLng,o=r.maxLng,u=r.minLat,c=r.maxLat;if(e>=i&&e<=o)return t<u?x((t-u)*w):t>c?x((t-c)*w):0;const s=Math.min(x((e-i)*w),x((e-o)*w)),h=K(t,s);return h>u&&h<c?_(s,n,t,h):Math.min(_(s,n,t,u),_(s,n,t,c))}function J(e,t){return e.dist-t.dist}function x(e){const t=Math.sin(e/2);return t*t}function _(e,t,n,r){return t*Math.cos(r*w)*e+x((n-r)*w)}function C(e,t,n,r,i){const o=x((e-n)*w);return _(o,i,t,r)}function K(e,t){const n=1-2*t;return n<=0?e>0?90:-90:Math.atan(Math.tan(e*w)/n)/w}function V(e,t,n={}){n.mutate!==!0&&(e=R(e));const r=n.minPoints||3,i=new D(e.features.length);for(const f of e.features)i.add(f.geometry.coordinates[0],f.geometry.coordinates[1]);i.finish();var o=e.features.map(f=>!1),u=e.features.map(f=>!1),c=e.features.map(f=>!1),s=e.features.map(f=>-1);const h=f=>{const a=e.features[f],[d,p]=a.geometry.coordinates;return Y(i,d,p,void 0,t).map(l=>({minX:e.features[l].geometry.coordinates[0],minY:e.features[l].geometry.coordinates[1],maxX:e.features[l].geometry.coordinates[0],maxY:e.features[l].geometry.coordinates[1],index:l}))},y=(f,a)=>{for(var d=0;d<a.length;d++){var p=a[d];const l=p.index;if(!o[l]){o[l]=!0;const g=h(l);g.length>=r&&a.push(...g)}u[l]||(u[l]=!0,s[l]=f)}};var m=0;return e.features.forEach((f,a)=>{if(o[a])return;const d=h(a);if(d.length>=r){const p=m;m++,o[a]=!0,y(p,d)}else c[a]=!0}),e.features.forEach((f,a)=>{var d=e.features[a];d.properties||(d.properties={}),s[a]>=0?(d.properties.dbscan=c[a]?"edge":"core",d.properties.cluster=s[a]):d.properties.dbscan="noise"}),e}var Z=V;export{V as clustersDbscan,Z as default};
