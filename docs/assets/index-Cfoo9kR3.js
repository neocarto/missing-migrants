import{l as K,d as L,a as P}from"./index-DWCRgfoN.js";function Q(n){if(!n)throw new Error("geojson is required");switch(n.type){case"Feature":return O(n);case"FeatureCollection":return U(n);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return S(n);default:throw new Error("unknown GeoJSON type")}}function O(n){const t={type:"Feature"};return Object.keys(n).forEach(e=>{switch(e){case"type":case"properties":case"geometry":return;default:t[e]=n[e]}}),t.properties=C(n.properties),n.geometry==null?t.geometry=null:t.geometry=S(n.geometry),t}function C(n){const t={};return n&&Object.keys(n).forEach(e=>{const i=n[e];typeof i=="object"?i===null?t[e]=null:Array.isArray(i)?t[e]=i.map(s=>s):t[e]=C(i):t[e]=i}),t}function U(n){const t={type:"FeatureCollection"};return Object.keys(n).forEach(e=>{switch(e){case"type":case"features":return;default:t[e]=n[e]}}),t.features=n.features.map(e=>O(e)),t}function S(n){const t={type:n.type};return n.bbox&&(t.bbox=n.bbox),n.type==="GeometryCollection"?(t.geometries=n.geometries.map(e=>S(e)),t):(t.coordinates=D(n.coordinates),t)}function D(n){const t=n;return typeof t[0]!="object"?t.slice():t.map(e=>D(e))}function H(n,t,e,i,s){N(n,t,e||0,i||n.length-1,s||V)}function N(n,t,e,i,s){for(;i>e;){if(i-e>600){var r=i-e+1,a=t-e+1,o=Math.log(r),c=.5*Math.exp(2*o/3),h=.5*Math.sqrt(o*c*(r-c)/r)*(a-r/2<0?-1:1),u=Math.max(e,Math.floor(t-a*c/r+h)),x=Math.min(i,Math.floor(t+(r-a)*c/r+h));N(n,t,u,x,s)}var d=n[t],f=e,l=i;for(Y(n,e,t),s(n[i],d)>0&&Y(n,e,i);f<l;){for(Y(n,f,l),f++,l--;s(n[f],d)<0;)f++;for(;s(n[l],d)>0;)l--}s(n[e],d)===0?Y(n,e,l):(l++,Y(n,l,i)),l<=t&&(e=l+1),t<=l&&(i=l-1)}}function Y(n,t,e){var i=n[t];n[t]=n[e],n[e]=i}function V(n,t){return n<t?-1:n>t?1:0}class W{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const i=[];if(!w(t,e))return i;const s=this.toBBox,r=[];for(;e;){for(let a=0;a<e.children.length;a++){const o=e.children[a],c=e.leaf?s(o):o;w(t,c)&&(e.leaf?i.push(o):b(t,c)?this._all(o,i):r.push(o))}e=r.pop()}return i}collides(t){let e=this.data;if(!w(t,e))return!1;const i=[];for(;e;){for(let s=0;s<e.children.length;s++){const r=e.children[s],a=e.leaf?this.toBBox(r):r;if(w(t,a)){if(e.leaf||b(t,a))return!0;i.push(r)}}e=i.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let i=0;i<t.length;i++)this.insert(t[i]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const i=this.data;this.data=e,e=i}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=X([]),this}remove(t,e){if(!t)return this;let i=this.data;const s=this.toBBox(t),r=[],a=[];let o,c,h;for(;i||r.length;){if(i||(i=r.pop(),c=r[r.length-1],o=a.pop(),h=!0),i.leaf){const u=Z(t,i.children,e);if(u!==-1)return i.children.splice(u,1),r.push(i),this._condense(r),this}!h&&!i.leaf&&b(i,s)?(r.push(i),a.push(o),o=0,c=i,i=i.children[0]):c?(o++,i=c.children[o],h=!1):i=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const i=[];for(;t;)t.leaf?e.push(...t.children):i.push(...t.children),t=i.pop();return e}_build(t,e,i,s){const r=i-e+1;let a=this._maxEntries,o;if(r<=a)return o=X(t.slice(e,i+1)),g(o,this.toBBox),o;s||(s=Math.ceil(Math.log(r)/Math.log(a)),a=Math.ceil(r/Math.pow(a,s-1))),o=X([]),o.leaf=!1,o.height=s;const c=Math.ceil(r/a),h=c*Math.ceil(Math.sqrt(a));A(t,e,i,h,this.compareMinX);for(let u=e;u<=i;u+=h){const x=Math.min(u+h-1,i);A(t,u,x,c,this.compareMinY);for(let d=u;d<=x;d+=c){const f=Math.min(d+c-1,x);o.children.push(this._build(t,d,f,s-1))}}return g(o,this.toBBox),o}_chooseSubtree(t,e,i,s){for(;s.push(e),!(e.leaf||s.length-1===i);){let r=1/0,a=1/0,o;for(let c=0;c<e.children.length;c++){const h=e.children[c],u=v(h),x=k(t,h)-u;x<a?(a=x,r=u<r?u:r,o=h):x===a&&u<r&&(r=u,o=h)}e=o||e.children[0]}return e}_insert(t,e,i){const s=i?t:this.toBBox(t),r=[],a=this._chooseSubtree(s,this.data,e,r);for(a.children.push(t),y(a,s);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(s,r,e)}_split(t,e){const i=t[e],s=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,s);const a=this._chooseSplitIndex(i,r,s),o=X(i.children.splice(a,i.children.length-a));o.height=i.height,o.leaf=i.leaf,g(i,this.toBBox),g(o,this.toBBox),e?t[e-1].children.push(o):this._splitRoot(i,o)}_splitRoot(t,e){this.data=X([t,e]),this.data.height=t.height+1,this.data.leaf=!1,g(this.data,this.toBBox)}_chooseSplitIndex(t,e,i){let s,r=1/0,a=1/0;for(let o=e;o<=i-e;o++){const c=_(t,0,o,this.toBBox),h=_(t,o,i,this.toBBox),u=j(c,h),x=v(c)+v(h);u<r?(r=u,s=o,a=x<a?x:a):u===r&&x<a&&(a=x,s=o)}return s||i-e}_chooseSplitAxis(t,e,i){const s=t.leaf?this.compareMinX:$,r=t.leaf?this.compareMinY:z,a=this._allDistMargin(t,e,i,s),o=this._allDistMargin(t,e,i,r);a<o&&t.children.sort(s)}_allDistMargin(t,e,i,s){t.children.sort(s);const r=this.toBBox,a=_(t,0,e,r),o=_(t,i-e,i,r);let c=I(a)+I(o);for(let h=e;h<i-e;h++){const u=t.children[h];y(a,t.leaf?r(u):u),c+=I(a)}for(let h=i-e-1;h>=e;h--){const u=t.children[h];y(o,t.leaf?r(u):u),c+=I(o)}return c}_adjustParentBBoxes(t,e,i){for(let s=i;s>=0;s--)y(e[s],t)}_condense(t){for(let e=t.length-1,i;e>=0;e--)t[e].children.length===0?e>0?(i=t[e-1].children,i.splice(i.indexOf(t[e]),1)):this.clear():g(t[e],this.toBBox)}}function Z(n,t,e){if(!e)return t.indexOf(n);for(let i=0;i<t.length;i++)if(e(n,t[i]))return i;return-1}function g(n,t){_(n,0,n.children.length,t,n)}function _(n,t,e,i,s){s||(s=X(null)),s.minX=1/0,s.minY=1/0,s.maxX=-1/0,s.maxY=-1/0;for(let r=t;r<e;r++){const a=n.children[r];y(s,n.leaf?i(a):a)}return s}function y(n,t){return n.minX=Math.min(n.minX,t.minX),n.minY=Math.min(n.minY,t.minY),n.maxX=Math.max(n.maxX,t.maxX),n.maxY=Math.max(n.maxY,t.maxY),n}function $(n,t){return n.minX-t.minX}function z(n,t){return n.minY-t.minY}function v(n){return(n.maxX-n.minX)*(n.maxY-n.minY)}function I(n){return n.maxX-n.minX+(n.maxY-n.minY)}function k(n,t){return(Math.max(t.maxX,n.maxX)-Math.min(t.minX,n.minX))*(Math.max(t.maxY,n.maxY)-Math.min(t.minY,n.minY))}function j(n,t){const e=Math.max(n.minX,t.minX),i=Math.max(n.minY,t.minY),s=Math.min(n.maxX,t.maxX),r=Math.min(n.maxY,t.maxY);return Math.max(0,s-e)*Math.max(0,r-i)}function b(n,t){return n.minX<=t.minX&&n.minY<=t.minY&&t.maxX<=n.maxX&&t.maxY<=n.maxY}function w(n,t){return t.minX<=n.maxX&&t.minY<=n.maxY&&t.maxX>=n.minX&&t.maxY>=n.minY}function X(n){return{children:n,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function A(n,t,e,i,s){const r=[t,e];for(;r.length;){if(e=r.pop(),t=r.pop(),e-t<=i)continue;const a=t+Math.ceil((e-t)/i/2)*i;H(n,a,t,e,s),r.push(t,a,a,e)}}function tt(n,t,e={}){e.mutate!==!0&&(n=Q(n));const i=e.minPoints||3,s=K(t,e.units);var r=new W(n.features.length),a=n.features.map(f=>!1),o=n.features.map(f=>!1),c=n.features.map(f=>!1),h=n.features.map(f=>-1);r.load(n.features.map((f,l)=>{var[m,M]=f.geometry.coordinates;return{minX:m,minY:M,maxX:m,maxY:M,index:l}}));const u=f=>{const l=n.features[f],[m,M]=l.geometry.coordinates,p=Math.max(M-s,-90),B=Math.min(M+s,90),E=(function(){return p<0&&B>0?s:Math.abs(p)<Math.abs(B)?s/Math.cos(P(B)):s/Math.cos(P(p))})(),F=Math.max(m-E,-360),R=Math.min(m+E,360),T={minX:F,minY:p,maxX:R,maxY:B};return r.search(T).filter(q=>{const G=q.index,J=n.features[G];return L(l,J,{units:"kilometers"})<=t})},x=(f,l)=>{for(var m=0;m<l.length;m++){var M=l[m];const p=M.index;if(!a[p]){a[p]=!0;const B=u(p);B.length>=i&&l.push(...B)}o[p]||(o[p]=!0,h[p]=f)}};var d=0;return n.features.forEach((f,l)=>{if(a[l])return;const m=u(l);if(m.length>=i){const M=d;d++,a[l]=!0,x(M,m)}else c[l]=!0}),n.features.forEach((f,l)=>{var m=n.features[l];m.properties||(m.properties={}),h[l]>=0?(m.properties.dbscan=c[l]?"edge":"core",m.properties.cluster=h[l]):m.properties.dbscan="noise"}),n}var it=tt;export{tt as clustersDbscan,it as default};
